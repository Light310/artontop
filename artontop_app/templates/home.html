<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <title>ArtOnTop - –ì–ª–∞–≤–Ω–∞—è</title>
</head>
<body class="bg-home">
    <div class="bg-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <header class="top-header">
        <a href="{{ url_for('create_pub') }}" class="btn-new-pub-glam">
            <span>+</span> –ù–æ–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è
        </a>

        <form action="{{ url_for('home') }}" method="GET" class="search-form">
            <input type="hidden" name="pub_type" value="{{ active_type }}">
            <input type="text" name="search" class="search-input" placeholder="#–ø–æ–∏—Å–∫ –ø–æ —Ö–µ—à—Ç–µ–≥—É..." 
                   value="{{ search_query if search_query and search_query != '–í—Å–µ' else '' }}">
            <button type="submit" class="btn-search">–ü–æ–∏—Å–∫</button>
            {% if mode == 'grid' or active_type != '–í—Å–µ —Ç–∏–ø—ã' %}
                <a href="{{ url_for('home') }}" class="btn-reset">–°–±—Ä–æ—Å–∏—Ç—å</a>
            {% else %}
                <span class="btn-reset disabled">–°–±—Ä–æ—Å–∏—Ç—å</span>
            {% endif %}
        </form>
        <div style="width: 200px;"></div> 
    </header>

    <div class="type-tabs">
        <a href="{{ url_for('home', pub_type='–í—Å–µ —Ç–∏–ø—ã') }}" class="tab-item {{ 'active' if active_type == '–í—Å–µ —Ç–∏–ø—ã' }}">–í—Å–µ —Ç–∏–ø—ã</a>
        {% for t in content_types %}
        <a href="{{ url_for('home', pub_type=t) }}" class="tab-item {{ 'active' if active_type == t }}">{{ t }}</a>
        {% endfor %}
    </div>

    <div class="feed-container">
        {% if mode == 'grid' %}
            <h2 class="row-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {{ search_query if search_query else '–í—Å–µ' }} <span style="font-size: 0.6em; opacity: 0.7;">({{ active_type }})</span></h2>
            <div class="grid-layout">
                {% for pub in pubs %}
                <div class="art-item grid-item" onclick="openPost({{ pub.id }})">
                    <img src="/static/uploads/{{ pub.image }}" alt="{{ pub.title }}">
                    <div class="item-overlay">{{ pub.title }}</div>
                </div>
                {% else %}
                <p style="color:white; grid-column: 1/-1; text-align: center; padding: 50px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
                {% endfor %}
            </div>
            {% if next_page %}
            <div class="pagination-area">
                <a href="{{ url_for('home', search=search_query, pub_type=active_type, page=next_page) }}" class="btn-arrow-down">‚ñº</a>
            </div>
            {% endif %}
        {% else %}
            <h2 class="row-title">–°–≤–µ–∂–µ–µ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {{ active_type }}</h2>
            <div class="row-wrapper" style="position: relative; display: flex; align-items: center;">
                <div class="art-bar" id="bar-fresh">
                    {% for pub in all_pubs[:20] %} 
                    <div class="art-item" onclick="openPost({{ pub.id }})">
                        <img src="/static/uploads/{{ pub.image }}">
                    </div>
                    {% endfor %}
                </div>
                <a href="{{ url_for('home', search='–í—Å–µ', pub_type=active_type) }}" class="btn-more-outer" id="btn-fresh">–µ—â—ë</a>
            </div>
            {% for tag in top_tags %}
            <h2 class="row-title">#{{ tag }}</h2>
            <div class="row-wrapper" style="position: relative; display: flex; align-items: center;">
                <div class="art-bar" id="bar-{{ tag }}">
                    {% set count = namespace(value=0) %}
                    {% for pub in all_pubs %}
                        {% if tag in pub.hashtags and count.value < 20 %} 
                        <div class="art-item" onclick="openPost({{ pub.id }})">
                            <img src="/static/uploads/{{ pub.image }}">
                        </div>
                        {% set count.value = count.value + 1 %}
                        {% endif %}
                    {% endfor %}
                </div>
                <a href="{{ url_for('home', search=tag, pub_type=active_type) }}" class="btn-more-outer" id="btn-{{ tag }}">–µ—â—ë</a>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <div id="postModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="modal-body">
                <div class="modal-image-container">
                    <img id="modalImage" src="" alt="Artwork">
                </div>
                
                <div class="modal-info">
                    <h1 id="modalTitle" style="margin-top:0; color: #333;"></h1>
                    <h3 id="modalAuthor" style="color: #7E7482; margin-bottom: 20px;"></h3>
                    
                    <div class="scrollable-info">
                        <p id="modalDesc" style="line-height: 1.6;"></p>
                        <p id="modalTags" style="color: #7E7482; font-weight: bold; margin-top: 15px;"></p>
                    </div>

                    <button id="btnDeleteRemix" class="delete-btn" style="display:none; margin-top:10px; width:100%; border:none; cursor:pointer;">
                        üóë –£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ–º–∏–∫—Å
                    </button>

                    <div id="commentsSection" style="display:none; margin-top:20px; background:#f9f9f9; padding:10px; border-radius:10px;">
                        <h4 style="margin:0 0 10px 0;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>
                        <div id="commentsList" style="max-height:150px; overflow-y:auto; margin-bottom:10px; font-size:13px;"></div>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="commentInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." class="input-field" style="margin:0; font-size:12px;">
                            <button onclick="sendComment()" class="btn-search" style="padding:5px 15px;">></button>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <a id="btnRemix" href="#" class="btn-new-pub-glam" style="font-size: 14px; padding: 8px 20px;">
                            <span>üé®</span> –°–¥–µ–ª–∞—Ç—å —Ä–µ–º–∏–∫—Å
                        </a>
                    </div>

                    <div id="remixSection" style="margin-top: 30px; display: none;">
                        <h3 style="color: #7E7482; border-bottom: 1px solid #ddd; padding-bottom: 5px;">–†–µ–º–∏–∫—Å—ã —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</h3>
                        <div id="remixList" style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;"></div>
                    </div>

                    <div id="ownerControls" class="owner-panel" style="display:none; margin-top:30px; border-top: 1px solid #eee; padding-top: 20px;">
                        <h4 style="margin-bottom: 10px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é</h4>
                        <form id="editForm" method="POST">
                            <input type="text" name="title" id="editTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" class="input-field">
                            <textarea name="description" id="editDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="input-field" rows="3"></textarea>
                            <input type="text" name="hashtags" id="editTags" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" class="input-field">
                            <select name="pub_type" id="editType" class="input-field">
                                {% for t in content_types %}
                                <option value="{{ t }}">{{ t }}</option>
                                {% endfor %}
                            </select>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button type="submit" class="btn-search">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <a id="deleteLink" href="" class="delete-btn" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å?')">–£–¥–∞–ª–∏—Ç—å</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('postModal');
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let currentContext = 'pub'; // 'pub' –∏–ª–∏ 'remix'
        let originalPostData = null; // –î–∞–Ω–Ω—ã–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        let activeObjectId = null;   // ID —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏–ª–∏ —Ä–µ–º–∏–∫—Å–∞)
        let currentUserId = null;
    
        function checkOverflow() {
            const bars = document.querySelectorAll('.art-bar');
            bars.forEach(bar => {
                const btn = bar.parentElement.querySelector('.btn-more-outer');
                if (btn) {
                    if (bar.scrollWidth > bar.clientWidth) btn.style.display = 'flex';
                    else btn.style.display = 'none';
                }
            });
        }
        window.addEventListener('load', checkOverflow);
        window.addEventListener('resize', checkOverflow);
    
        function openPost(id) {
            fetch(`/get_post/${id}`)
                .then(res => res.json())
                .then(data => {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
                    originalPostData = data;
                    currentUserId = data.current_user_id;
                    
                    // –†–µ–Ω–¥–µ—Ä–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                    renderOriginalView();
                    
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                });
        }
    
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –û–†–ò–ì–ò–ù–ê–õ–ê
        function renderOriginalView() {
            const data = originalPostData;
            currentContext = 'pub';
            activeObjectId = data.id;
    
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ UI
            document.getElementById('modalImage').src = `/static/uploads/${data.image}`;
            document.getElementById('modalTitle').innerText = data.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
            document.getElementById('modalAuthor').innerText = `–ê–≤—Ç–æ—Ä: ${data.author_name}`;
            document.getElementById('modalDesc').innerText = data.description;
            document.getElementById('modalTags').innerText = data.hashtags;
            document.getElementById('btnRemix').href = `/editor/${data.id}`;
            document.getElementById('btnRemix').style.display = 'inline-flex';
    
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–º–∏–∫—Å–∞ (–º—ã –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
            document.getElementById('btnDeleteRemix').style.display = 'none';
    
            // –ü–∞–Ω–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞)
            const controls = document.getElementById('ownerControls');
            if(data.is_owner) {
                controls.style.display = 'block';
                document.getElementById('editForm').action = `/edit/${data.id}`;
                document.getElementById('editTitle').value = data.title || "";
                document.getElementById('editDesc').value = data.description;
                document.getElementById('editTags').value = data.hashtags;
                document.getElementById('editType').value = data.pub_type;
                document.getElementById('deleteLink').href = `/delete/${data.id}`;
            } else {
                controls.style.display = 'none';
            }
    
            // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Ä–µ–º–∏–∫—Å–æ–≤ (–≤–∫–ª—é—á–∞—è –∏–∫–æ–Ω–∫—É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞)
            renderRemixList(data.remixes, null); // null –∑–Ω–∞—á–∏—Ç "–∞–∫—Ç–∏–≤–µ–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª"
    
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –û–†–ò–ì–ò–ù–ê–õ–ê
            loadComments('pub', data.id);
        }
    
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –†–ï–ú–ò–ö–°–ê
        function switchToRemixView(remix) {
            currentContext = 'remix';
            activeObjectId = remix.id;
    
            document.getElementById('modalImage').src = `/static/uploads/${remix.image}`;
            document.getElementById('modalTitle').innerText = "–†–µ–º–∏–∫—Å";
            document.getElementById('modalAuthor').innerText = `–ê–≤—Ç–æ—Ä —Ä–µ–º–∏–∫—Å–∞: ${remix.author_name}`;
            document.getElementById('modalDesc').innerText = `–î–∞—Ç–∞: ${remix.date}`;
            document.getElementById('modalTags').innerText = ""; // –£ —Ä–µ–º–∏–∫—Å–æ–≤ –Ω–µ—Ç —Ç–µ–≥–æ–≤
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º
            document.getElementById('ownerControls').style.display = 'none';
            document.getElementById('btnRemix').style.display = 'none'; // –ù–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å —Ä–µ–º–∏–∫—Å –Ω–∞ —Ä–µ–º–∏–∫—Å (–ø–æ–∫–∞)
    
            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–º–∏–∫—Å–∞
            const delBtn = document.getElementById('btnDeleteRemix');
            if (remix.author_id === currentUserId) {
                delBtn.style.display = 'block';
                delBtn.onclick = () => deleteRemix(remix.id);
            } else {
                delBtn.style.display = 'none';
            }
    
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–º–∏–∫—Å–æ–≤, —á—Ç–æ–±—ã –≤—ã–¥–µ–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π
            renderRemixList(originalPostData.remixes, remix.id);
    
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –†–ï–ú–ò–ö–°–ê
            loadComments('remix', remix.id);
        }
    
        function renderRemixList(remixes, activeRemixId) {
            const remixSection = document.getElementById('remixSection');
            const remixList = document.getElementById('remixList');
            remixList.innerHTML = '';
    
            if ((!remixes || remixes.length === 0) && !activeRemixId) {
                remixSection.style.display = 'none';
                return;
            }
            remixSection.style.display = 'block';
    
            // 1. –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É "–û–†–ò–ì–ò–ù–ê–õ" –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            const origDiv = createRemixThumb(
                originalPostData.image, 
                "–û—Ä–∏–≥–∏–Ω–∞–ª", 
                activeRemixId === null // –ï—Å–ª–∏ activeRemixId null, –∑–Ω–∞—á–∏—Ç –≤—ã–±—Ä–∞–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª
            );
            origDiv.onclick = () => renderOriginalView();
            remixList.appendChild(origDiv);
    
            // 2. –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–º–∏–∫—Å—ã
            if(remixes) {
                remixes.forEach(remix => {
                    const rDiv = createRemixThumb(
                        remix.image, 
                        remix.author_name, 
                        activeRemixId === remix.id
                    );
                    rDiv.onclick = () => switchToRemixView(remix);
                    remixList.appendChild(rDiv);
                });
            }
        }
    
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã
        function createRemixThumb(imageName, label, isActive) {
            const div = document.createElement('div');
            div.style.minWidth = '80px';
            div.style.textAlign = 'center';
            div.style.fontSize = '11px';
            div.style.cursor = 'pointer';
            div.style.opacity = isActive ? '1' : '0.6';
            div.style.transition = '0.2s';
            
            // –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ —è—Ä—á–µ
            div.onmouseenter = () => div.style.opacity = '1';
            div.onmouseleave = () => { if(!isActive) div.style.opacity = '0.6'; };
    
            const img = document.createElement('img');
            img.src = `/static/uploads/${imageName}`;
            img.style.width = '70px';
            img.style.height = '70px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '12px';
            img.style.border = isActive ? '3px solid #ff9a9e' : '2px solid transparent';
            
            const span = document.createElement('div');
            span.innerText = label;
            span.style.marginTop = '4px'; 
            span.style.color = '#333';
            span.style.fontWeight = isActive ? 'bold' : 'normal';
    
            div.appendChild(img);
            div.appendChild(span);
            return div;
        }
    
        // --- –õ–û–ì–ò–ö–ê –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è) ---
        
        function loadComments(type, id) {
            const section = document.getElementById('commentsSection');
            const list = document.getElementById('commentsList');
            section.style.display = 'block';
            list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            
            // –í—ã–±–∏—Ä–∞–µ–º URL –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ (–ø—É–±–ª–∏–∫–∞—Ü–∏—è –∏–ª–∏ —Ä–µ–º–∏–∫—Å)
            const url = type === 'pub' 
                ? `/get_pub_comments/${id}` 
                : `/get_remix_comments/${id}`;
    
            fetch(url)
            .then(res => res.json())
            .then(data => {
                list.innerHTML = '';
                if(data.comments.length === 0) list.innerHTML = '<i style="color:#999">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</i>';
                
                data.comments.forEach(c => {
                    const p = document.createElement('p');
                    p.style.margin = '5px 0';
                    p.innerHTML = `<b>${c.author}</b>: ${c.text} <span style="color:#aaa; font-size:10px;">${c.date}</span>`;
                    list.appendChild(p);
                });
                list.scrollTop = list.scrollHeight;
            });
        }
    
        function sendComment() {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            if(!text || !activeObjectId) return;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—É–¥–∞ —Å–ª–∞—Ç—å
            const url = currentContext === 'pub' ? '/add_pub_comment' : '/add_remix_comment';
            const payload = currentContext === 'pub' 
                ? { pub_id: activeObjectId, text: text }
                : { remix_id: activeObjectId, text: text };
    
            fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    input.value = '';
                    loadComments(currentContext, activeObjectId); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞
                } else if (data.error === 'Unauthorized') {
                    alert("–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å");
                }
            });
        }
    
        function deleteRemix(id) {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ–º–∏–∫—Å –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
            fetch(`/delete_remix/${id}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ä–µ–º–∏–∫—Å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É
                    alert('–†–µ–º–∏–∫—Å —É–¥–∞–ª–µ–Ω');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–º–∏–∫—Å–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    originalPostData.remixes = originalPostData.remixes.filter(r => r.id !== id);
                    renderOriginalView(); 
                }
            });
        }
    
        document.querySelector('.close-modal').onclick = () => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        };
    
        window.onclick = (e) => {
            if(e.target == modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        };
    </script>
</body>
</html>